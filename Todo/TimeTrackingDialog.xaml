<Window x:Class="Todo.TimeTrackingDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Time tracking" Height="760" Width="900" WindowStartupLocation="CenterOwner" ResizeMode="NoResize" MinHeight="760" MaxHeight="760" MinWidth="900" MaxWidth="900">
    <Window.Resources>
        <DataTemplate x:Key="DayItemTemplate">
            <Border x:Name="RootBorder" Padding="6" Margin="2" CornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="120" />
                        <ColumnDefinition Width="120" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="{Binding DateString}" FontWeight="Bold" />
                        <TextBlock Text="{Binding Weekday}" FontStyle="Italic" FontSize="12" />
                        <!-- New: show day type text -->
                        <TextBlock Text="{Binding DayType}" FontSize="11" Foreground="Gray" />
                    </StackPanel>
                    <TextBlock Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <Run Text="Worked: " />
                        <Run Text="{Binding WorkedDisplay, Mode=OneWay}" />
                    </TextBlock>
                    <TextBlock Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <Run Text="Std: " />
                        <!-- Updated: show computed target hours instead of standard -->
                        <Run Text="{Binding TargetDisplay, Mode=OneWay}" />
                    </TextBlock>
                </Grid>
            </Border>
            <DataTemplate.Triggers>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="MonthGridItemTemplate">
            <Border x:Name="MonthBorder" Padding="6" Margin="2" CornerRadius="4" MouseLeftButtonUp="MonthGridItem_Click" Background="{Binding BackgroundBrush}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Date.Day}" FontWeight="Bold" FontSize="16" HorizontalAlignment="Center" />
                </StackPanel>
                <Border.Style>
                    <Style TargetType="Border">
                        <!-- default border appearance set via Style so Triggers can override -->
                        <Setter Property="BorderBrush" Value="Transparent" />
                        <Setter Property="BorderThickness" Value="1" />
                        <Style.Triggers>
                            <!-- Today indicator: green border -->
                            <DataTrigger Binding="{Binding IsToday}" Value="True">
                                <Setter Property="BorderBrush" Value="#FF2E8B57"/>
                                <Setter Property="BorderThickness" Value="2"/>
                            </DataTrigger>

                            <!-- Selected date indicator: blue thicker border. Keep this after IsToday so it wins when both true. -->
                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                <Setter Property="BorderBrush" Value="#FF007ACC"/>
                                <Setter Property="BorderThickness" Value="3"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="380" />
        </Grid.ColumnDefinitions>

        <!-- Left column: month grid and days list -->
        <StackPanel Grid.Column="0">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Top" Margin="0,0,0,6">
                <ComboBox x:Name="YearCombo" Width="120" SelectionChanged="YearCombo_SelectionChanged"/>
                <ComboBox x:Name="MonthCombo" Width="150" Margin="8,0,0,0" SelectionChanged="MonthCombo_SelectionChanged"/>
                <Button Content="Today" Margin="8,0,0,0" Click="TodayButton_Click" />
                <CheckBox x:Name="ColorModeCheck" Content="Color by physical location" Margin="8,0,0,0" VerticalAlignment="Center" Checked="ColorModeCheck_Checked" Unchecked="ColorModeCheck_Unchecked" />
            </StackPanel>

            <!-- Custom month grid with tall narrow prev/next buttons -->
            <Grid Width="468" Height="220">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="24" />
                    <ColumnDefinition Width="420" />
                    <ColumnDefinition Width="24" />
                </Grid.ColumnDefinitions>
                <Button Grid.Column="0" Width="24" Height="220" Click="PrevMonthButton_Click" VerticalAlignment="Stretch" HorizontalAlignment="Center" Padding="0">
                    <Path Fill="#666666" Stretch="Uniform" Margin="2" Data="M 16 0 L 0 10 L 16 20 Z" />
                </Button>
                <ItemsControl x:Name="MonthGrid" Grid.Column="1" ItemTemplate="{StaticResource MonthGridItemTemplate}" Width="420" Height="220">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="7" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
                <Button Grid.Column="2" Width="24" Height="220" Click="NextMonthButton_Click" VerticalAlignment="Stretch" HorizontalAlignment="Center" Padding="0">
                    <Path Fill="#666666" Stretch="Uniform" Margin="2" Data="M 0 0 L 16 10 L 0 20 Z" />
                </Button>
            </Grid>

            <TextBlock Text="Days in month" FontWeight="Bold" Margin="0,6,0,4" />
            <ListBox x:Name="DaysList" ItemTemplate="{StaticResource DayItemTemplate}" SelectionChanged="DaysList_SelectionChanged"
                     Width="{Binding ActualWidth, ElementName=MonthGrid}"
                     Height="360"
                     ScrollViewer.VerticalScrollBarVisibility="Auto" />
        </StackPanel>

        <!-- Right column: details and templates -->
        <DockPanel Grid.Column="1" Margin="12,0,0,0">
            <!-- Footer docked to bottom so action buttons remain visible -->
            <StackPanel DockPanel.Dock="Bottom" Orientation="Vertical" Margin="0,8,0,0">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <StackPanel>
                        <TextBlock Text="Account: Holiday" FontWeight="Bold" />
                        <TextBlock x:Name="AccountHolidayValue" Text="0.00 days" />
                    </StackPanel>
                    <Button Content="Reset" Margin="12,0,0,0" Click="ResetHoliday_Click" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,8,0,0" VerticalAlignment="Center">
                    <StackPanel>
                        <TextBlock Text="Account: Time in Lieu" FontWeight="Bold" />
                        <TextBlock x:Name="AccountTILValue" Text="00:00" />
                    </StackPanel>
                    <Button Content="Reset" Margin="12,0,0,0" Click="ResetTIL_Click" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,0">
                    <Button Content="View Log" Click="ViewLog_Click" />
                    <!-- New: Export year colour map (PDF) -->
                    <Button Content="Export year colour map (PDF)" Click="ExportYearMap_Click" Margin="6,0,0,0" />
                </StackPanel>
            </StackPanel>

            <!-- Main content scrolls if it grows so footer stays visible -->
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <StackPanel>
                    <!-- Details header and selected date on same line -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                        <TextBlock Text="Details" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" />
                        <TextBlock x:Name="SelectedDateLabel" Text="" FontWeight="Normal" FontSize="13" Margin="12,0,0,0" VerticalAlignment="Center" Foreground="Gray" />
                    </StackPanel>

                    <Grid Margin="0,6,0,6">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0">
                            <TextBlock Text="Employment Position" />
                            <ComboBox x:Name="PositionCombo" IsEditable="True" />
                        </StackPanel>

                        <StackPanel Grid.Row="1" Margin="0,6,0,0">
                            <TextBlock Text="Location" />
                            <ComboBox x:Name="LocationCombo" IsEditable="True" />
                        </StackPanel>

                        <StackPanel Grid.Row="2" Margin="0,6,0,0">
                            <TextBlock Text="Day Type" />
                            <ComboBox x:Name="DayTypeCombo" SelectionChanged="DayTypeCombo_SelectionChanged" />
                        </StackPanel>
                    </Grid>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <StackPanel>
                            <TextBlock Text="Physical Location" />
                            <ComboBox x:Name="PhysicalLocationCombo" IsEditable="True" Width="240"/>
                        </StackPanel>
                        <StackPanel Orientation="Vertical" HorizontalAlignment="Right" Margin="8,18,0,0">
                            <Button Content="Bulk apply" Click="SaveDefaults_Click" Width="110"/>
                        </StackPanel>
                    </StackPanel>

                    <GroupBox Header="Shifts" Margin="0,6,0,6">
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,4,0,4">
                                <Button Content="Add" Click="AddShift_Click" Margin="0,0,6,0" />
                                <Button Content="Edit" Click="EditShift_Click" Margin="0,0,6,0" />
                                <Button Content="Delete" Click="DeleteShift_Click" />
                            </StackPanel>
                            <StackPanel>
                                <ListBox x:Name="ShiftsList" MouseDoubleClick="ShiftsList_MouseDoubleClick">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="4">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                        <TextBlock x:Name="StartText" FontWeight="Bold" Text="{Binding StartDisplay}" Foreground="Black" />
                                                        <TextBlock Text=" " />
                                                        <TextBlock x:Name="StartInfo" Text="&#x2139;" Foreground="DodgerBlue" Margin="6,0,0,0" Visibility="Collapsed" />
                                                        <TextBlock Text=" - " Margin="6,0" />
                                                        <TextBlock x:Name="EndText" FontWeight="Bold" Text="{Binding EndDisplay}" Foreground="Black" />
                                                        <TextBlock Text=" " />
                                                        <TextBlock x:Name="EndInfo" Text="&#x2139;" Foreground="DodgerBlue" Margin="6,0,0,0" Visibility="Collapsed" />
                                                        <!-- worked and lunch for this shift -->
                                                        <TextBlock Text="  " />
                                                        <TextBlock Text="(" Foreground="Gray" />
                                                        <TextBlock Text="Worked " Foreground="Gray" />
                                                        <TextBlock Text="{Binding WorkedHhmm}" Foreground="Gray" />
                                                        <TextBlock Text=", " Foreground="Gray" />
                                                        <TextBlock Text="Lunch " Foreground="Gray" />
                                                        <TextBlock Text="{Binding LunchHhmm}" Foreground="Gray" />
                                                        <TextBlock Text=")" Foreground="Gray" />
                                                    </StackPanel>
                                                    <TextBlock Text="{Binding Description}" FontStyle="Italic" FontSize="12" />
                                                    <TextBlock Text="{Binding DayModeDisplay}" FontSize="11" Foreground="Gray" />
                                                </StackPanel>
                                            </Border>
                                            <DataTemplate.Triggers>
                                                <DataTrigger Binding="{Binding ManualStartOverride}" Value="True">
                                                    <Setter TargetName="StartText" Property="Foreground" Value="Red" />
                                                    <Setter TargetName="StartInfo" Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding ManualEndOverride}" Value="True">
                                                    <Setter TargetName="EndText" Property="Foreground" Value="Red" />
                                                    <Setter TargetName="EndInfo" Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <!-- Totals/footer: stacked rows to prevent overlap -->
                                <StackPanel Margin="6,8,6,0">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                        <TextBlock Text="Hours worked:" VerticalAlignment="Center" />
                                        <TextBlock x:Name="TotalWorkedDataTextBlock" Text="00:00" FontWeight="Bold" Margin="8,0,0,0" VerticalAlignment="Center" Foreground="Black" MinWidth="72" TextAlignment="Left" />
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                        <TextBlock Text="Target hours:" VerticalAlignment="Center" />
                                        <TextBox x:Name="ShiftTargetText" Width="80" Margin="8,0,0,0" LostFocus="ShiftTargetText_LostFocus" />
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Delta:" VerticalAlignment="Center" />
                                        <TextBlock x:Name="TotalDeltaDataTextBlock" Text="00:00" FontWeight="Bold" Margin="8,0,0,0" VerticalAlignment="Center" ToolTip="Delta = total worked - target hours. Positive = extra hours worked; negative = shortfall." />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </DockPanel>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>
     </Grid>
 </Window>